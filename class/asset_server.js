var AssetServer,coffee,fs,less;fs=require("fs"),less=require("less"),coffee=require("coffee-script"),module.exports=AssetServer=function(){function e(e,t){this.root_dir=null!=e?e:""+__dirname.replace(/class/,"assets"),this.res=t}return e.prototype.less_opts={compress:!1,paths:["./assets/less"]},e.prototype.coffee_opts={},e.prototype.serve_stylesheet=function(e,t){var s,r,o;if(null==t&&(t=!1),"test"!==process.env.NODE_ENV&&console.log("AssetServer::stylesheet "+e),e=e.replace(/css/g,"less"),this.res.writeHead("200","Content-Type: text/css"),t)s=e;else try{s=fs.readFileSync(""+this.root_dir+e,"UTF-8")}catch(o){return r=o,this.do404()}return less.render(s,this.less_opts,function(e){return function(t,s){return e.res.end(s.css)}}(this))},e.prototype.serve_coffeescript=function(e){var t,s,r,o;"test"!==process.env.NODE_ENV&&console.log("AssetServer::coffeescript "+e),e=e.replace(/\.js/,".coffee"),this.res.writeHead("200","Content-Type: text/javascript");try{t=fs.readFileSync(""+this.root_dir+e,"UTF-8")}catch(r){s=r,e=e.replace(/\.coffee/,".js");try{t=fs.readFileSync(""+this.root_dir+e,"UTF-8")}catch(o){return s=o,"test"!==process.env.NODE_ENV&&console.log("tried to find "+e+" (or coffee alternative) and neither existed"),this.do404()}}return t=coffee.compile(this.process_replacements(t)),this.res.end(t)},e.prototype.serve_javascript=function(e){var t,s,r;"test"!==process.env.NODE_ENV&&console.log("AssetServer::javascript "+e),this.res.writeHead("200","Content-Type: text/javascript");try{t=fs.readFileSync(""+this.root_dir+e,"UTF-8")}catch(r){return s=r,this.do404()}return this.res.end(t)},e.prototype.serve_image=function(e){var t,s,r;"test"!==process.env.NODE_ENV&&console.log("AssetServer::image "+e),this.res.writeHead("200","Content-Type: text/"+e.substr(e.lastIndexOf(".")+1));try{t=fs.readFileSync(""+this.root_dir+e)}catch(r){return s=r,"test"!==process.env.NODE_ENV&&console.log("AssetServer::image "+e+" !! file not found"),this.do404()}return this.res.end(t||!1)},e.prototype.serve_audio=function(e){var t,s,r;"test"!==process.env.NODE_ENV&&console.log("AssetServer::audio "+e),this.res.writeHead("200","Content-Type: audio/mpeg");try{t=fs.readFileSync(""+this.root_dir+e)}catch(r){return s=r,this.do404()}return this.res.end(t)},e.prototype.do404=function(){return this.res.writeHead("404","Content-Type: text/plain"),this.res.end("your classic 404, not found")},e.prototype.process_replacements=function(e){var t,s,r,o,n,i,c,p,a,f,l;if(a=e.match(/#(\s+|)\{\{(prepend|append|insert):([a-zA-Z0-9\-_\/]+)\}\}/g),f={},!a||!a.length)return e;for(n=0,c=a.length;c>n;n++)p=a[n],f.hasOwnProperty(p)||(t=p.match(/(prepend|append|insert):/),s=p.match(/:([a-zA-Z0-9\-_\/]+)/),o=this.root_dir+"/coffee/"+s[1]+".coffee",r=this.process_replacements(fs.readFileSync(o,"UTF-8")),f[p]={action:t[1],file:s[1],contents:r});for(i in f)l=f[i],l.action.indexOf("pend")>-1&&(e=e.replace(new RegExp(i,"g"),"")),"append"===l.action?e+=l.contents:e="prepend"===l.action?l.contents+e:e.replace(new RegExp(i,"g"),l.contents);return e},e}();