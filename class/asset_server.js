(function(){var e,t,r,s;r=require("fs"),s=require("less"),t=require("coffee-script"),module.exports=e=function(){function e(e,t){this.root_dir=null!=e?e:""+__dirname.replace(/class/,"assets"),this.res=t}return e.prototype.less_opts={compress:!1,paths:["./assets/less"]},e.prototype.coffee_opts={},e.prototype.serve_stylesheet=function(e,t){var n,o,i;if(null==t&&(t=!1),"test"!==process.env.NODE_ENV&&console.log("AssetServer::stylesheet "+e),e=e.replace(/css/g,"less"),this.res.writeHead("200","Content-Type: text/css"),t)return this.res.end(e);try{n=r.readFileSync(""+this.root_dir+e,"UTF-8")}catch(i){return o=i,this.do404()}return s.render(n,this.less_opts,function(e){return function(t,r){return e.res.end(r.css)}}(this))},e.prototype.serve_coffeescript=function(e){var s,n,o,i;"test"!==process.env.NODE_ENV&&console.log("AssetServer::coffeescript "+e),e=e.replace(/\.js/,".coffee"),this.res.writeHead("200","Content-Type: text/javascript");try{s=r.readFileSync(""+this.root_dir+e,"UTF-8")}catch(o){n=o,e=e.replace(/\.coffee/,".js");try{s=r.readFileSync(""+this.root_dir+e,"UTF-8")}catch(i){return n=i,"test"!==process.env.NODE_ENV&&console.log("tried to find "+e+" (or coffee alternative) and neither existed"),this.do404()}}return s=t.compile(this.process_replacements(s)),this.res.end(s)},e.prototype.serve_javascript=function(e){var t,s,n;"test"!==process.env.NODE_ENV&&console.log("AssetServer::javascript "+e),this.res.writeHead("200","Content-Type: text/javascript");try{t=r.readFileSync(""+this.root_dir+e,"UTF-8")}catch(n){return s=n,this.do404()}return this.res.end(t)},e.prototype.serve_image=function(e){var t,s,n;"test"!==process.env.NODE_ENV&&console.log("AssetServer::image "+e),this.res.writeHead("200","Content-Type: text/"+e.substr(e.lastIndexOf(".")+1));try{t=r.readFileSync(""+this.root_dir+e)}catch(n){return s=n,"test"!==process.env.NODE_ENV&&console.log("AssetServer::image "+e+" !! file not found"),this.do404()}return this.res.end(t||!1)},e.prototype.serve_audio=function(e){var t,s,n;"test"!==process.env.NODE_ENV&&console.log("AssetServer::audio "+e),this.res.writeHead("200","Content-Type: audio/mpeg");try{t=r.readFileSync(""+this.root_dir+e)}catch(n){return s=n,this.do404()}return this.res.end(t)},e.prototype.do404=function(){return this.res.writeHead("404","Content-Type: text/plain"),this.res.end("your classic 404, not found")},e.prototype.process_replacements=function(e){var t,s,n,o,i,c,p,a,d,l,h;if(d=e.match(/#(\s+|)\{\{(prepend|append|insert):([a-zA-Z0-9\-_\/]+)\}\}/g),l={},!d||!d.length)return e;for(i=0,p=d.length;p>i;i++)a=d[i],l.hasOwnProperty(a)||(t=a.match(/(prepend|append|insert):/),s=a.match(/:([a-zA-Z0-9\-_\/]+)/),o=this.root_dir+"/coffee/"+s[1]+".coffee",n=this.process_replacements(r.readFileSync(o,"UTF-8")),l[a]={action:t[1],file:s[1],contents:n});for(c in l)h=l[c],h.action.indexOf("pend")>-1&&(e=e.replace(new RegExp(c,"g"),"")),"append"===h.action?e+=h.contents:e="prepend"===h.action?h.contents+e:e.replace(new RegExp(c,"g"),h.contents);return e},e}()}).call(this);